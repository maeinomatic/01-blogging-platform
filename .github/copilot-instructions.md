# GitHub Copilot Instructions for Blogging Platform

This document provides guidance for GitHub Copilot when working with this repository.

## Project Overview

A full-stack blogging platform with user authentication, rich text editor, comments, and search functionality.

**Tech Stack:**
- **Backend:** Python, FastAPI, SQLModel, SQLAlchemy
- **Database:** PostgreSQL (via Docker for local development)
- **Authentication:** JWT with passlib for password hashing
- **Migrations:** Alembic
- **Frontend:** React (planned), Tailwind CSS
- **Editor:** React-Quill or TinyMCE (planned)

## Project Structure

```
├── .github/                 # GitHub configuration and workflows
├── server/                  # FastAPI backend
│   ├── api/                # API route handlers (auth, posts, comments)
│   ├── core/               # Core utilities (config, db, security)
│   ├── models/             # SQLModel database models
│   └── main.py             # FastAPI application entry point
├── client/                  # React frontend (planned)
├── alembic/                # Database migration files
├── scripts/                # Helper scripts for development
├── docker-compose.yml      # Docker services configuration
├── requirements.txt        # Python dependencies
├── ONBOARDING.md          # Developer onboarding guide
├── PLAN.md                # Backend implementation plan
└── README.md              # Project documentation
```

## Development Environment

### Prerequisites
- Python 3.10+
- Docker & Docker Compose
- Node.js & npm (for frontend)
- Git

### Setup Steps
1. Copy `.env.example` to `.env` and configure secrets
2. Start PostgreSQL: `docker-compose up -d`
3. Create Python virtual environment: `python -m venv .venv`
4. Activate venv:
   - Windows PowerShell: `. .\.venv\Scripts\Activate.ps1`
   - macOS/Linux: `source .venv/bin/activate`
5. Install dependencies: `pip install -r requirements.txt`
6. Run database migrations: `python -m alembic upgrade head`
7. Start backend: `uvicorn server.main:app --reload --port 5000`

### Important Environment Variables
- `DATABASE_URL`: PostgreSQL connection string 
  - **Local development (backend on host)**: `postgresql+asyncpg://postgres:postgres@localhost:5432/blogdb`
  - **Docker Compose (backend in container)**: `postgresql+asyncpg://postgres:postgres@db:5432/blogdb`
  - ⚠️ **WARNING**: Default credentials (postgres:postgres) are for local development only. Always use strong, unique credentials for staging and production environments.
- `JWT_SECRET`: Secret key for JWT token generation (must be set to a secure random string, never use defaults in production)
- `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`, `POSTGRES_PORT`: Database credentials (change defaults for non-local environments)

## Code Style and Conventions

### Python Backend
- **Async/await**: All database operations use async/await pattern with asyncpg
- **Type hints**: Use type hints for all function parameters and return values
- **SQLModel**: Database models inherit from SQLModel with `table=True` for ORM models
- **Pydantic models**: Use separate models for create/read/update operations (e.g., `UserCreate`, `UserRead`)
- **UUID primary keys**: Use UUID for all primary keys with `Field(default_factory=uuid4)`
- **Timestamps**: Include `created_at` and `updated_at` fields where appropriate
- **Soft deletes**: Prefer soft deletes with `deleted_at` field over hard deletes
- **Password security**: Always hash passwords using passlib before storing
- **JWT tokens**: Use python-jose for JWT token generation and validation

### API Design
- **RESTful routes**: Follow REST conventions
- **Route prefix**: Use `/api` prefix for all API endpoints
- **Status codes**: Use appropriate HTTP status codes (200, 201, 400, 401, 403, 404, 500)
- **Error handling**: Return consistent error response format
- **Authentication**: Protected endpoints should use dependency injection for auth
- **CORS**: Already configured in main.py for development

### Database Models
- **Naming**: Use singular names for tables (e.g., `User`, `Post`, `Comment`)
- **Relationships**: Define relationships using SQLModel's relationship features
- **Indexes**: Add indexes for frequently queried fields (email, username, slug, etc.)
- **Full-text search**: Use PostgreSQL tsvector and GIN indexes for search functionality
- **Denormalization**: Keep counters (comments_count, likes_count) on parent models
- **JSONB**: Use JSONB columns for flexible metadata storage

### Migrations (Alembic)
- **Autogenerate**: Use `alembic revision --autogenerate -m "description"` for new migrations
- **Import models**: Ensure all models are imported in `alembic/env.py` via SQLModel.metadata
- **Apply migrations**: Run `python -m alembic upgrade head` to apply migrations
- **Review migrations**: Always review autogenerated migrations before committing
- **Naming**: Use descriptive migration names (e.g., "add_post_search_vector", "create_user_table")

## Testing and Quality

### Testing (when implemented)
- Use `pytest` for unit and integration tests
- Use `pytest-asyncio` for async test support
- Use `httpx` for API integration tests
- Test database operations against the actual PostgreSQL container
- Mock external services but test database interactions

### Linting and Formatting
- **black**: Code formatter (run: `black .`)
- **ruff**: Fast Python linter (run: `ruff .`)
- **pre-commit**: Automated pre-commit hooks (if configured)

## Common Commands

### Backend Development
```bash
# Start database
docker-compose up -d

# Activate virtual environment
source .venv/bin/activate  # macOS/Linux
. .\.venv\Scripts\Activate.ps1  # Windows PowerShell

# Install dependencies
pip install -r requirements.txt

# Run database migrations
python -m alembic upgrade head

# Create new migration
alembic revision --autogenerate -m "description"

# Start backend server
uvicorn server.main:app --reload --port 5000

# Run tests
pytest

# Format code
black .

# Lint code
ruff .
```

### Docker Commands
```bash
# Start all services
docker-compose up -d

# View logs
docker-compose logs -f db

# Stop services
docker-compose down

# Check database health
docker-compose exec db pg_isready -U postgres
```

### Git Commands
```bash
# Check status
git --no-pager status

# View diff
git --no-pager diff

# Commit changes
git add .
git commit -m "descriptive message"
git push
```

## API Documentation

Once the server is running, access:
- **Swagger UI**: http://127.0.0.1:5000/docs
- **ReDoc**: http://127.0.0.1:5000/redoc
- **OpenAPI JSON**: http://127.0.0.1:5000/openapi.json
- **Health check**: http://127.0.0.1:5000/health

## Security Considerations

- **Never commit secrets**: Keep JWT_SECRET and database passwords in `.env` (gitignored)
- **Password hashing**: Always use passlib with bcrypt for password hashing
- **JWT validation**: Verify JWT tokens on all protected endpoints
- **SQL injection**: Use SQLModel/SQLAlchemy parameterized queries (already handled)
- **Input validation**: Use Pydantic models for request validation
- **CORS**: Configure CORS appropriately for production (currently allows all origins for development)

## Key Features and Implementation Notes

### Authentication
- JWT-based authentication with access tokens
- Password hashing using passlib[bcrypt]
- User registration and login endpoints in `server/api/auth.py`
- Protected routes use dependency injection for authentication

### Blog Posts
- CRUD operations for blog posts
- Support for draft and published states
- Rich text content storage (raw, HTML, and JSON formats)
- Slug generation for SEO-friendly URLs
- Full-text search using PostgreSQL tsvector

### Comments
- Nested comment threads with parent_id relationships
- Support for comment moderation
- Soft delete for comments

### Database Schema
- Users table with email, username, password_hash, profile fields
- Posts table with author relationship, content fields, metadata
- Comments table with post and author relationships, threading support
- Tags and post_tags for many-to-many tagging
- Post_likes and bookmarks for user interactions
- Media table for uploaded attachments
- Refresh_tokens for session management

## Troubleshooting

### Common Issues
- **"DB not ready"**: Check with `docker-compose logs db` and `docker-compose exec db pg_isready -U postgres`
- **Alembic errors**: Ensure all models are imported and SQLModel.metadata is populated in `alembic/env.py`
- **Virtual environment issues on Windows**: Run `Set-ExecutionPolicy -Scope Process -ExecutionPolicy RemoteSigned -Force`
- **IntelliSense/import errors**: Ensure correct Python interpreter is selected (`.venv`) and dependencies are installed

### Database Connection
- **Recommended setup (backend on host, database in Docker)**: 
  - Backend connects to Docker database at `localhost:5432`
  - Use DATABASE_URL: `postgresql+asyncpg://postgres:postgres@localhost:5432/blogdb`
- **Alternative setup (both in Docker Compose)**: 
  - Backend connects using service name `db:5432`
  - Use DATABASE_URL: `postgresql+asyncpg://postgres:postgres@db:5432/blogdb`
- **Connection string format**: `postgresql+asyncpg://user:password@host:port/database`
- The default configuration in `.env.example` assumes backend runs on host, connecting to database in Docker

## Best Practices When Assisting

1. **Read existing code**: Review related files before suggesting changes
2. **Follow patterns**: Match existing code style and patterns in the repository
3. **Minimal changes**: Make the smallest changes necessary to achieve the goal
4. **Test changes**: Suggest testing commands after code changes
5. **Documentation**: Update relevant documentation when making significant changes
6. **Security first**: Always consider security implications of code changes
7. **Async patterns**: Use async/await consistently for database operations
8. **Error handling**: Include proper error handling and validation
9. **Type safety**: Use type hints and Pydantic models for validation
10. **Database migrations**: Create Alembic migrations for schema changes

## Additional Resources

- **FastAPI documentation**: https://fastapi.tiangolo.com/
- **SQLModel documentation**: https://sqlmodel.tiangolo.com/
- **Alembic documentation**: https://alembic.sqlalchemy.org/
- **Pydantic documentation**: https://docs.pydantic.dev/

## Notes for Copilot

- This is an active development project
- Frontend (React) is planned but not yet implemented
- Focus on backend API development with FastAPI and SQLModel
- Database schema follows the design outlined in PLAN.md
- Always use async/await patterns for database operations
- Prefer composition over inheritance for code reusability
- Keep business logic separate from route handlers
- Write clear, self-documenting code with good variable names
